const CSDS = require('./csds-cache');
const axios = require('axios');
const {_cleanAxiosErrorForLogging} = require("./axiosHelper");

async function getMsgStatistics({accountId, token, userId = null}) {

    // first get the service domain
    const host = await CSDS.lookup(accountId, CSDS.ServiceName.asyncMessagingEnt);

    const brands = `/brands/${accountId}`;
    const agents = userId !== null ? `/agents/${userId}` : '';

    // https://va-lt.facade-msg.liveperson.net/api/messaging/rest/reporting/brands/22983036/msgstatistics?v=1&_=1568832644769&__d=84645
    // https://va-lt.facade-msg.liveperson.net/api/messaging/rest/reporting/brands/22983036/agents/805227432/msgstatistics?v=1&_=1568839338169&__d=46179
    const url = `${CSDS.defaultHttpProtocol}://${host}/api/messaging/rest/reporting${brands}${agents}/msgstatistics?v=1&_=${Date.now()}`;

    try {
        const res = await axios({
            method: 'get',
            url,
            headers: {
                'Content-Type': 'application/json',
                'User-Agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 10_3 like Mac OS X) AppleWebKit/602.1.50 (KHTML, like Gecko) CriOS/56.0.2924.75 Mobile/14E5239e Safari/602.1',
                'Authorization': `Bearer ${token}`
            }
        });

        return res;

    } catch (err) {
        // catch axios errors, clean up and re-throw
        throw _cleanAxiosErrorForLogging(err);
    }
}

module.exports = {getMsgStatistics};
